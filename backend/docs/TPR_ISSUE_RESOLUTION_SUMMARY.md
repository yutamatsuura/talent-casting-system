# TPRスコア相違問題 解決レポート

## 問題概要

**発生日**: 2025年12月15日
**症状**: 診断システムCSV出力でサンドウィッチマンのTPRスコアが25.7となるが、ソースデータでは35.7

## 調査結果

### 根本原因
1. **target_segment_id マッピングの不整合**
   - TPR更新スクリプトが間違ったsegment_id（1-8）を使用
   - 実際のデータはsegment_id（9-16）に格納済み
   - 診断システムは正常に動的変換を実行

2. **データ構造の二重管理**
   - 個人タレント：主にsegment_id 1-8
   - コンビ・グループ：segment_id 9-16
   - 診断システムは`segment_name → segment_id`動的変換で両対応

### 技術的発見事項
- SQLAlchemy ORM定義とテーブル構造の不一致（idカラム問題）
- base_power_score計算ロジックの確認
- 名前マッチング精度92.0%達成

## 解決アクション

### 1. TPR更新スクリプト修正
```python
# 修正前（間違い）
TPR_FILES_MAPPING = {
    "TPR_男性12～19_202508.csv": 13,  # ❌
    # ...
}

# 修正後（正しい）
TPR_FILES_MAPPING = {
    "TPR_男性12～19_202508.csv": 9,   # ✅
    "TPR_女性12～19_202508.csv": 10,  # ✅
    # ...
}
```

### 2. データベース更新方法修正
- SQLAlchemy ORMからRaw SQLに変更
- `column talent_scores.id does not exist`エラーを回避

### 3. マニュアルマッピング追加
```python
MANUAL_NAME_MAPPING = {
    "フィッシャーズ": "Fischer's",      # account_id: 2881
    "イチロー": "鈴木一朗（イチロー）",  # account_id: 647
    "ヒカキン": "HIKAKIN",            # account_id: 482
}
```

## 実行結果

### スクリプト実行統計
- **処理対象**: 8個のTPRファイル
- **総レコード数**: 10,240件
- **マッチング成功**: 9,416件（92.0%）
- **実行時間**: 約40分

### 主要タレント更新確認
| タレント名 | account_id | 更新前 | 更新後 | ステータス |
|------------|------------|--------|--------|------------|
| サンドウィッチマン | 729 | 25.7 | **35.7** | ✅ 修正完了 |
| HIKAKIN | 482 | - | **30.3** | ✅ 更新完了 |
| Fischer's | 2881 | - | **29.3** | ✅ 更新完了 |

## 予防策・今後の改善

### 1. 運用手順標準化
- ドライラン必須実行
- マッチング率90%以上を合格基準
- 重要タレントの個別確認

### 2. 技術的改善
- segment_id統一化の検討（将来的な課題）
- 自動化レベルの向上
- 診断システムでのリアルタイム確認

### 3. ドキュメント整備
- 運用マニュアル作成: `docs/TPR_DATA_MANAGEMENT.md`
- トラブルシューティングガイド
- 定期メンテナンス手順

## 検証完了項目

✅ **データベース更新確認**
```sql
-- サンドウィッチマン TPRスコア: 35.7 に正常更新
SELECT tpr_power_score FROM talent_scores
WHERE account_id = 729 AND target_segment_id = 9;
```

✅ **診断システム動作確認**
- 男性12-19歳診断でサンドウィッチマン TPRスコア 35.7 表示

✅ **スクリプト安定性確認**
- Raw SQL による安全な更新処理
- エラーハンドリング改善

## 影響範囲

### 修正されたデータ
- コンビ・グループ: 約3,000アカウント
- TPRスコア: 約10,000レコード更新
- base_power_score: 自動再計算

### システム停止時間
- **なし** (本番稼働中にバックグラウンド実行)

## 完了確認

🎯 **主要目標**: サンドウィッチマンTPRスコア 25.7 → 35.7 修正
✅ **結果**: 正常に修正完了

📊 **データ品質**: マッチング精度 92.0%
✅ **結果**: 目標90%を上回る

⚡ **システム影響**: 無停止での更新
✅ **結果**: 正常稼働継続

---

**対応完了日**: 2025年12月15日 18:40
**対応者**: AI Assistant
**検証者**: ユーザー確認済み