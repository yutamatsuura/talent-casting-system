# Phase Bè¶…æœ€é©åŒ–ç‰ˆ å®Œå…¨æ€§æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ

**æ¤œè¨¼æ—¥æ™‚:** 2025-12-09
**æ¤œè¨¼ç›®çš„:** Phase Bè¶…æœ€é©åŒ–ç‰ˆãŒã€Œé«˜é€Ÿã ãŒå‡¦ç†ãŒä¸å®Œå…¨ã€ãªã®ã‹ã€ã€Œæ­£ã—ãæœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‰é«˜é€Ÿã€ãªã®ã‹ã‚’å¾¹åº•æ¤œè¨¼

---

## ğŸ”¥ çµè«–: Phase Bã¯ã€Œæ­£ã—ãæœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‰é«˜é€Ÿã€

Phase Aã«è‡´å‘½çš„ãªå®Ÿè£…æ¼ã‚ŒãŒã‚ã‚Šã€Phase BãŒå®Œå…¨ã‹ã¤é«˜é€Ÿãªå®Ÿè£…ã§ã‚ã‚‹ã“ã¨ãŒè¨¼æ˜ã•ã‚Œã¾ã—ãŸã€‚

---

## ğŸ“Š æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼

### å‡¦ç†æ™‚é–“æ¯”è¼ƒ

| é …ç›® | Phase Aï¼ˆå¾“æ¥ç‰ˆï¼‰ | Phase Bï¼ˆè¶…æœ€é©åŒ–ç‰ˆï¼‰ | æ”¹å–„ç‡ |
|------|-------------------|----------------------|--------|
| å‡¦ç†æ™‚é–“ | **5,814.44ms** | **2,834.47ms** | **51.3%é«˜é€ŸåŒ–** |
| DBæ¥ç¶šå›æ•° | 3å›ä»¥ä¸Š | 2å› | 33%å‰Šæ¸›ä»¥ä¸Š |

### ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§æ¯”è¼ƒ

| æ¤œè¨¼é …ç›® | Phase A | Phase B | çµæœ |
|----------|---------|---------|------|
| ã‚¿ãƒ¬ãƒ³ãƒˆæ•°ï¼ˆ30åï¼‰ | âœ“ 30ä»¶ | âœ“ 30ä»¶ | **ä¸¡è€…ä¸€è‡´** |
| ãƒ‡ãƒ¼ã‚¿æ¬ æ | âœ— **å…¨30ä»¶ã‚¹ã‚³ã‚¢æ¬ æ** | âœ“ ãªã— | **Phase Bå‹åˆ©** |
| ã‚¹ã‚³ã‚¢ç¯„å›²ï¼ˆ86-99ç‚¹ï¼‰ | âœ— ãƒ‡ãƒ¼ã‚¿ãªã— | âœ“ 86.2ã€œ99.4ç‚¹ | **Phase Bå‹åˆ©** |
| ã‚¿ãƒ¬ãƒ³ãƒˆIDä¸€è‡´ç‡ | - | **100.0%** | **å®Œå…¨ä¸€è‡´** |
| é †ä½å¸¯åˆ¥äººæ•° | âœ“ æ­£ã—ã„ | âœ“ æ­£ã—ã„ | **ä¸¡è€…ä¸€è‡´** |

---

## ğŸ” è©³ç´°åˆ†æ

### 1. STEP 0-5 å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—æ¯”è¼ƒ

#### Phase Aï¼ˆmatching.pyå†… execute_matching_logic + apply_recommended_talents_integrationï¼‰

```
âœ“ STEP 0: äºˆç®—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
âœ“ STEP 1: åŸºç¤ãƒ‘ãƒ¯ãƒ¼å¾—ç‚¹è¨ˆç®— (VR + TPR) / 2
âœ“ STEP 2: æ¥­ç¨®ã‚¤ãƒ¡ãƒ¼ã‚¸æŸ»å®š (PERCENT_RANK())
âœ“ STEP 3: åŸºç¤åæ˜ å¾—ç‚¹ (STEP1 + STEP2)
âœ“ STEP 4: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç¢ºå®š (LIMIT 30)
âœ— STEP 5: ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢æŒ¯ã‚Šåˆ†ã‘ â†’ **å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„**
âœ“ ãŠã™ã™ã‚ã‚¿ãƒ¬ãƒ³ãƒˆçµ±åˆ
âœ— CMå‡ºæ¼”ãƒã‚§ãƒƒã‚¯ â†’ **Phase Aã§ã¯æœªçµ±åˆ**
```

#### Phase Bï¼ˆultra_optimized_queries.pyï¼‰

```
âœ“ STEP 0: äºˆç®—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° + ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¥­ç•Œå¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿
âœ“ STEP 1: åŸºç¤ãƒ‘ãƒ¯ãƒ¼å¾—ç‚¹è¨ˆç®— (VR + TPR) / 2
âœ“ STEP 2: æ¥­ç¨®ã‚¤ãƒ¡ãƒ¼ã‚¸æŸ»å®š (PERCENT_RANK())
âœ“ STEP 3: åŸºç¤åæ˜ å¾—ç‚¹ (STEP1 + STEP2)
âœ“ STEP 4: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç¢ºå®š (LIMIT 30)
âœ“ STEP 5: ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢æŒ¯ã‚Šåˆ†ã‘ (apply_step5_score_distribution_optimized)
âœ“ ãŠã™ã™ã‚ã‚¿ãƒ¬ãƒ³ãƒˆçµ±åˆ (CTEå†…ã§å®Œçµ)
âœ“ CMå‡ºæ¼”ãƒã‚§ãƒƒã‚¯ (check_currently_in_cm_with_category_filter)
```

### 2. Phase Aã®è‡´å‘½çš„ãªå®Ÿè£…æ¼ã‚Œ

#### å•é¡Œ1: STEP 5ã‚¹ã‚³ã‚¢æŒ¯ã‚Šåˆ†ã‘ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„

**è¨¼æ‹ :**
```python
# matching.py 738è¡Œ: é–¢æ•°ã¯å®šç¾©ã•ã‚Œã¦ã„ã‚‹
def apply_step5_score_distribution(results: List[Dict]) -> List[Dict]:
    """STEP 5: ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢æŒ¯ã‚Šåˆ†ã‘ï¼ˆé †ä½é †ã‚¹ã‚³ã‚¢ï¼‰"""
    # ...

# ã—ã‹ã—ã€grepçµæœã§å‘¼ã³å‡ºã—ç®‡æ‰€ãŒ0ä»¶
$ grep -n "apply_step5_score_distribution" matching.py
738:def apply_step5_score_distribution(results: List[Dict]) -> List[Dict]:
```

**å½±éŸ¿:**
- Phase Aã®çµæœã¯å…¨30ä»¶ã§ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢ãŒ`None`ï¼ˆæ¬ æï¼‰
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«è¿”å´ã™ã‚‹éš›ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§

#### å•é¡Œ2: Phase Aã®`execute_unified_matching_query`ã¯å½è£…

**è¨¼æ‹ ï¼ˆoptimized_queries.py 33-52è¡Œï¼‰:**
```python
# Phase Aã®execute_unified_matching_queryã¯å®Ÿã¯æ—¢å­˜é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã ã‘ï¼
from app.api.endpoints.matching import execute_matching_logic

# ...
results = await execute_matching_logic(
    form_data,
    budget_max,
    target_segment_id,
    image_item_ids
)
```

**çµè«–:** Phase Aã¯ã€Œæœ€é©åŒ–ç‰ˆã€ã¨åä¹—ã£ã¦ã„ã‚‹ãŒã€å®Ÿéš›ã¯æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã ã‘ã§ã€çœŸã®çµ±åˆã‚¯ã‚¨ãƒªã¯å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ã€‚

### 3. Phase Bã®å®Œå…¨å®Ÿè£…

#### ç©¶æ¥µçµ±åˆã‚¯ã‚¨ãƒªï¼ˆ206è¡Œã®å®Œå…¨SQLã‚¯ã‚¨ãƒªï¼‰

Phase Bã¯ä»¥ä¸‹ã‚’**1ã¤ã®SQLã‚¯ã‚¨ãƒª**ã§å®Ÿè¡Œï¼š

```sql
WITH step0_budget_filter AS (...)  -- STEP 0
,step1_base_power AS (...)         -- STEP 1
,step2_adjustment AS (...)         -- STEP 2: PERCENT_RANK()
,step3_reflected_score AS (...)    -- STEP 3
,step4_ranking AS (...)            -- STEP 4
,step4_final AS (...)              -- LIMIT 30
,recommended_talents_query AS (...) -- ãŠã™ã™ã‚ã‚¿ãƒ¬ãƒ³ãƒˆ
,recommended_talent_scores AS (...)
SELECT ... FROM step4_final
FULL OUTER JOIN recommended_talent_scores
ORDER BY ...
LIMIT 30
```

#### STEP 5ã‚¹ã‚³ã‚¢æŒ¯ã‚Šåˆ†ã‘ã‚‚å®Œå…¨å®Ÿè£…

**è¨¼æ‹ ï¼ˆultra_optimized_queries.py 223-257è¡Œï¼‰:**
```python
def apply_step5_score_distribution_optimized(results: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """STEP 5: ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢æŒ¯ã‚Šåˆ†ã‘ï¼ˆå®Œå…¨ä¿æŒãƒ»é«˜é€ŸåŒ–ï¼‰"""
    # ã¾ãšæœ€çµ‚é †ä½ã‚’æ­£ã—ãå†è¨ˆç®—
    for i, result in enumerate(results):
        result['ranking'] = i + 1

    for result in results:
        ranking = result['ranking']

        # é †ä½ã«åŸºã¥ãæ®µéšçš„ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆç¯„å›²å†…ã§ä¸Šä½é †ä½ãŒé«˜ã„ã‚¹ã‚³ã‚¢ï¼‰
        if 1 <= ranking <= 3:
            base_score = 99.7 - ((ranking - 1) * 1.0)
            result['matching_score'] = round(base_score + random.uniform(-0.3, 0.0), 1)
        # ... ä»¥ä¸‹çœç•¥
```

**çµæœ:** Phase Bã¯å…¨30ä»¶ã§æ­£ã—ããƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢ã‚’ä»˜ä¸ï¼ˆ86.2ã€œ99.4ç‚¹ï¼‰

---

## ğŸ¯ å„æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆã®çµè«–

### 1. å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ã®å®Œå…¨æ€§ç¢ºèª

| ã‚¹ãƒ†ãƒƒãƒ— | Phase A | Phase B | çµè«– |
|----------|---------|---------|------|
| STEP 0 | âœ“ | âœ“ | ä¸¡è€…å®Œå…¨ |
| STEP 1 | âœ“ | âœ“ | ä¸¡è€…å®Œå…¨ |
| STEP 2 | âœ“ | âœ“ | ä¸¡è€…å®Œå…¨ |
| STEP 3 | âœ“ | âœ“ | ä¸¡è€…å®Œå…¨ |
| STEP 4 | âœ“ | âœ“ | ä¸¡è€…å®Œå…¨ |
| STEP 5 | **âœ— æœªå®Ÿè£…** | âœ“ | **Phase Bå®Œå…¨** |
| ãŠã™ã™ã‚ã‚¿ãƒ¬ãƒ³ãƒˆ | âœ“ï¼ˆåˆ¥å‡¦ç†ï¼‰ | âœ“ï¼ˆçµ±åˆæ¸ˆã¿ï¼‰ | **Phase Bæœ€é©** |

### 2. ãƒ‡ãƒ¼ã‚¿å–å¾—ã®å®Œå…¨æ€§ç¢ºèª

**Phase A:**
- âœ“ ã‚¿ãƒ¬ãƒ³ãƒˆæ•°: 30å
- âœ— **ã‚¹ã‚³ã‚¢: å…¨ä»¶æ¬ æ**
- âœ“ åå‰ãƒ»ã‚«ãƒ†ã‚´ãƒª: å®Œå…¨
- âœ— ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢ç¯„å›²: ãƒ‡ãƒ¼ã‚¿ãªã—

**Phase B:**
- âœ“ ã‚¿ãƒ¬ãƒ³ãƒˆæ•°: 30å
- âœ“ ã‚¹ã‚³ã‚¢: å…¨ä»¶å®Œå‚™
- âœ“ åå‰ãƒ»ã‚«ãƒ†ã‚´ãƒª: å®Œå…¨
- âœ“ ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢ç¯„å›²: **86.2ã€œ99.4ç‚¹ï¼ˆä»•æ§˜é€šã‚Šï¼‰**

### 3. SQLå®Ÿè¡Œã®è©³ç´°ãƒ­ã‚°ç¢ºèª

**Phase A:**
- DBæ¥ç¶š: 3å›ä»¥ä¸Šï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—ã€ãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œã€ãŠã™ã™ã‚ã‚¿ãƒ¬ãƒ³ãƒˆå–å¾—ï¼‰
- å‡¦ç†æ™‚é–“: 5,814.44ms

**Phase B:**
- DBæ¥ç¶š: **2å›**ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€æ‹¬å–å¾—ã€ç©¶æ¥µçµ±åˆã‚¯ã‚¨ãƒªï¼‰
- å‡¦ç†æ™‚é–“: **2,834.47ms**
- **é«˜é€ŸåŒ–ç‡: 51.3%**

### 4. åŒä¸€æ¡ä»¶ã§ã®çµæœæ¯”è¼ƒ

**æ¤œè¨¼æ¡ä»¶:**
- æ¥­ç¨®: åŒ–ç²§å“ãƒ»ãƒ˜ã‚¢ã‚±ã‚¢ãƒ»ã‚ªãƒ¼ãƒ©ãƒ«ã‚±ã‚¢
- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤: å¥³æ€§20-34æ­³
- äºˆç®—: 1,000ä¸‡å††ã€œ3,000ä¸‡å††æœªæº€

**çµæœ:**
- ã‚¿ãƒ¬ãƒ³ãƒˆIDä¸€è‡´ç‡: **100.0%**ï¼ˆå…±é€š30ä»¶ã€å·®åˆ†0ä»¶ï¼‰
- é †ä½å¸¯åˆ¥äººæ•°: **å®Œå…¨ä¸€è‡´**
- ãƒ‡ãƒ¼ã‚¿å“è³ª: **Phase BãŒå®Œå…¨ã€Phase Aã¯ã‚¹ã‚³ã‚¢æ¬ æ**

### 5. å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—ã®å¯èƒ½æ€§ç¢ºèª

**Phase A:**
- âœ— **STEP 5ãŒå®Œå…¨ã‚¹ã‚­ãƒƒãƒ—**
- âœ— ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ç„¡è¦–ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã¯ä½ã„ï¼ˆãã‚‚ãã‚‚å‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„ï¼‰

**Phase B:**
- âœ“ å…¨å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹
- âœ“ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚‚é©åˆ‡
- âœ“ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ä»£æ›¿ã•ã‚Œã¦ã„ã‚‹å‡¦ç†ãªã—

---

## ğŸ“Œ æœ€çµ‚çµè«–

### âœ… Phase Bã¯ã€Œæ­£ã—ãæœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‰é«˜é€Ÿã€

Phase Bè¶…æœ€é©åŒ–ç‰ˆã¯ã€ä»¥ä¸‹ã®ç†ç”±ã§**å®Œå…¨ã‹ã¤é«˜é€Ÿ**ã§ã‚ã‚‹ã¨æ–­è¨€ã§ãã¾ã™ï¼š

1. **å‡¦ç†ã®å®Œå…¨æ€§**
   - STEP 0-5ã‚’å®Œå…¨å®Ÿè£…
   - ãŠã™ã™ã‚ã‚¿ãƒ¬ãƒ³ãƒˆçµ±åˆã‚‚1ã‚¯ã‚¨ãƒªã§å®Œçµ
   - ãƒ‡ãƒ¼ã‚¿æ¬ æãªã—

2. **å‡¦ç†ã®æ­£ç¢ºæ€§**
   - ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢: 86.2ã€œ99.4ç‚¹ï¼ˆä»•æ§˜é€šã‚Šï¼‰
   - ã‚¿ãƒ¬ãƒ³ãƒˆIDä¸€è‡´ç‡: 100.0%
   - é †ä½å¸¯åˆ¥äººæ•°: å®Œå…¨ä¸€è‡´

3. **é«˜é€ŸåŒ–ã®æ­£å½“æ€§**
   - DBæ¥ç¶šæ•°å‰Šæ¸›: 3å› â†’ 2å›ï¼ˆ33%å‰Šæ¸›ä»¥ä¸Šï¼‰
   - ç©¶æ¥µçµ±åˆã‚¯ã‚¨ãƒª: 206è¡Œã®å®Œå…¨SQLã§1å›å®Ÿè¡Œ
   - å‡¦ç†æ™‚é–“: **51.3%é«˜é€ŸåŒ–**

4. **Phase Aã®å•é¡Œç‚¹**
   - STEP 5ã‚¹ã‚³ã‚¢æŒ¯ã‚Šåˆ†ã‘ãŒå®Ÿè£…æ¼ã‚Œ
   - ã€Œæœ€é©åŒ–ç‰ˆã€ã¨åä¹—ã£ã¦ã„ã‚‹ãŒå®Ÿéš›ã¯æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã¶ã ã‘
   - ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ãŒå…¨ä»¶æ¬ æ

### ğŸš€ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **Phase Bã‚’æœ¬ç•ªæ¡ç”¨**
   - `/api/matching` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§Phase Bå®Ÿè£…ã‚’ç¶™ç¶šä½¿ç”¨
   - Phase Aï¼ˆ`/api/optimized`ï¼‰ã¯å»ƒæ­¢æ¤œè¨

2. **Phase Aã®ä¿®æ­£ã¯ä¸è¦**
   - Phase BãŒå®Œå…¨ã«å‹•ä½œã—ã¦ã„ã‚‹ãŸã‚ã€Phase Aã‚’ä¿®æ­£ã™ã‚‹æ„å‘³ã¯ãªã„
   - Phase Aã®ã‚³ãƒ¼ãƒ‰ã¯å‚è€ƒç”¨ã¨ã—ã¦æ®‹ã™ã‹å‰Šé™¤

3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°**
   - Phase BãŒã€Œæ­£å¼ç‰ˆã€ã§ã‚ã‚‹ã“ã¨ã‚’æ˜è¨˜
   - Phase Aã®å•é¡Œç‚¹ã‚’è¨˜éŒ²ã¨ã—ã¦æ®‹ã™

---

## ğŸ“ æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿

### æ¤œè¨¼å®Ÿè¡Œãƒ­ã‚°
```
================================================================================
Phase A vs Phase B å®Œå…¨æ€§æ¤œè¨¼
================================================================================

ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1: åŒ–ç²§å“ãƒ»ãƒ˜ã‚¢ã‚±ã‚¢ãƒ»ã‚ªãƒ¼ãƒ©ãƒ«ã‚±ã‚¢ / å¥³æ€§20-34æ­³

Phase Aå®Ÿè¡Œä¸­...
âœ“ Phase Aå®Œäº†: 5814.44ms, 30ä»¶

Phase Bå®Ÿè¡Œä¸­...
âœ“ Phase Bå®Œäº†: 2834.47ms, 30ä»¶

âš¡ é«˜é€ŸåŒ–ç‡: 51.3%

ã€ã‚¿ãƒ¬ãƒ³ãƒˆæ•°ã€‘
  Phase A: 30ä»¶
  Phase B: 30ä»¶
  ä¸€è‡´: âœ“

ã€ãƒ‡ãƒ¼ã‚¿æ¬ æãƒã‚§ãƒƒã‚¯ã€‘
  Phase Aæ¬ æ: [å…¨30ä»¶ã‚¹ã‚³ã‚¢æ¬ æ]
  Phase Bæ¬ æ: ãªã— âœ“

ã€ã‚¹ã‚³ã‚¢ç¯„å›²ã€‘
  Phase A: ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ãªã—
  Phase B: 86.2 ã€œ 99.4 (å¹³å‡: 91.5)

ã€ã‚¿ãƒ¬ãƒ³ãƒˆIDä¸€è‡´ç‡ã€‘
  å…±é€šID: 30ä»¶
  Phase Aå°‚ç”¨: 0ä»¶
  Phase Bå°‚ç”¨: 0ä»¶
  ä¸€è‡´ç‡: 100.0%
```

---

**æ¤œè¨¼è€…:** AI Agent (Claude Code)
**æ¤œè¨¼å®Œäº†æ—¥æ™‚:** 2025-12-09
**æ¤œè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** âœ… å®Œäº†

---

## è£œè¶³: Phase Bã®æŠ€è¡“çš„å„ªä½æ€§

### 1. SQLçµ±åˆã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š

**Phase Aï¼ˆå¾“æ¥ç‰ˆï¼‰:**
```
æ¥ç¶š1: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾— (budget_max, target_segment_id, image_item_ids)
æ¥ç¶š2: ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ (STEP 0-4)
æ¥ç¶š3: ãŠã™ã™ã‚ã‚¿ãƒ¬ãƒ³ãƒˆå–å¾—
Pythonå‡¦ç†: ãŠã™ã™ã‚ã‚¿ãƒ¬ãƒ³ãƒˆçµ±åˆ
Pythonå‡¦ç†: STEP 5ã‚¹ã‚³ã‚¢æŒ¯ã‚Šåˆ†ã‘ï¼ˆæœªå®Ÿè£…ï¼‰
```

**Phase Bï¼ˆè¶…æœ€é©åŒ–ç‰ˆï¼‰:**
```
æ¥ç¶š1: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€æ‹¬å–å¾—ï¼ˆ1ã‚¯ã‚¨ãƒªã§å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
æ¥ç¶š2: ç©¶æ¥µçµ±åˆã‚¯ã‚¨ãƒªï¼ˆSTEP 0-4 + ãŠã™ã™ã‚ã‚¿ãƒ¬ãƒ³ãƒˆçµ±åˆï¼‰
Pythonå‡¦ç†: STEP 5ã‚¹ã‚³ã‚¢æŒ¯ã‚Šåˆ†ã‘ï¼ˆå®Œå…¨å®Ÿè£…ï¼‰
```

### 2. PostgreSQLæœ€é©åŒ–æŠ€è¡“ã®æ´»ç”¨

Phase BãŒä½¿ç”¨ã—ã¦ã„ã‚‹é«˜åº¦ãªSQLæŠ€è¡“ï¼š

1. **CTEï¼ˆCommon Table Expressionï¼‰ãƒã‚§ãƒ¼ãƒ³**
   - STEP 0-4ã‚’æ®µéšçš„ã«å®Ÿè¡Œ
   - ä¸­é–“çµæœã‚’åŠ¹ç‡çš„ã«å…±æœ‰

2. **PERCENT_RANK() OVER()å¥**
   - æ¥­ç¨®ã‚¤ãƒ¡ãƒ¼ã‚¸æŸ»å®šã®æ­£ç¢ºãªãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«è¨ˆç®—
   - NTILE()ã‚„percentile_cont()ã®åˆ¶ç´„ã‚’å›é¿

3. **UNION ALL + PERCENT_RANK() ãƒ‘ã‚¿ãƒ¼ãƒ³**
   - éæ­£è¦åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆ7åˆ—ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚³ã‚¢ï¼‰ã‚’æ­£è¦åŒ–
   - å‹•çš„ãªãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«è¨ˆç®—

4. **FULL OUTER JOIN**
   - ãŠã™ã™ã‚ã‚¿ãƒ¬ãƒ³ãƒˆã¨é€šå¸¸çµæœã‚’1ã‚¯ã‚¨ãƒªã§çµ±åˆ
   - é‡è¤‡é™¤å»ã‚‚è‡ªå‹•åŒ–

5. **DISTINCT ON + ROW_NUMBER()**
   - ã‚¿ãƒ¬ãƒ³ãƒˆé‡è¤‡é™¤å»
   - æ­£ç¢ºãªé †ä½ä»˜ã‘

### 3. ã‚³ãƒ¼ãƒ‰å“è³ªã®å·®

| è¦³ç‚¹ | Phase A | Phase B |
|------|---------|---------|
| ã‚³ãƒ¼ãƒ‰ã®æ˜ç¢ºæ€§ | âœ— è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†æ•£ | âœ“ 1ãƒ•ã‚¡ã‚¤ãƒ«ã«çµ±åˆ |
| ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ | âœ— 3å›ä»¥ä¸Šã®DBæ¥ç¶šãŒå¿…è¦ | âœ“ 2å›ã§å®Œçµ |
| ãƒ‡ãƒãƒƒã‚°å®¹æ˜“æ€§ | âœ— å‡¦ç†ãŒåˆ†æ•£ | âœ“ SQLãƒ­ã‚°ã§å…¨ä½“æŠŠæ¡å¯èƒ½ |
| ä¿å®ˆæ€§ | âœ— å¤‰æ›´ç®‡æ‰€ãŒå¤šã„ | âœ“ 1ã‚¯ã‚¨ãƒªä¿®æ­£ã§å®Œçµ |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | âœ— 5,814ms | âœ“ 2,834msï¼ˆ51.3%é«˜é€Ÿï¼‰ |

---

ä»¥ä¸Šã€Phase Bè¶…æœ€é©åŒ–ç‰ˆã®å®Œå…¨æ€§æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆã§ã—ãŸã€‚
